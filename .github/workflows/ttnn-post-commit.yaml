name: "[internal] ttnn unit tests impl"

on:
  workflow_call:
    inputs:
      enabled-skus:
        required: true
        type: string
        description: "Comma-separated SKUs (e.g. wh_n300_civ2). Maps to runs_on via .github/sku_config.yaml."
      docker-image:
        required: true
        type: string
      wheel-artifact-name:
        required: true
        type: string
      enable-watcher:
        required: false
        type: boolean
        default: false
      enable-lightweight-kernel-asserts:
        description: 'Enable lightweight kernel asserts'
        required: false
        type: boolean
        default: false
      enable-llk-asserts:
        description: 'Enable LLK asserts'
        required: false
        type: boolean
        default: false
      merge-gate-call:
        required: false
        type: boolean
        default: false
      ref:
        required: false
        type: string
        default: ""
        description: "Commit SHA to test (default: HEAD)"
      timeout-minutes-override:
        required: false
        type: number
        default: 0
        description: "If > 0, skip time budget verification and use this as job timeout (e.g. 240 for APC watcher, 120 for BHPC watcher)."

jobs:
  load-test-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.filter-matrix.outputs.matrix }}
    env:
      TESTS_YAML_PATH: ./tests/pipeline_reorg/ttnn-tests.yaml
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}
          sparse-checkout: |
            .github
            tests/pipeline_reorg
          sparse-checkout-cone-mode: true

      - name: Install dependencies
        run: |
          pip3 install PyYAML

      - name: Verify test timeouts against budget
        if: ${{ inputs.timeout-minutes-override == 0 }}
        run: |
          set -e
          python3 .github/scripts/utils/verify_time_budget.py \
            ${{ env.TESTS_YAML_PATH }} \
            ./.github/time_budget.yaml \
            "sanity"

      - name: Build test matrix based on enabled SKUs
        id: build-matrix
        run: |
          python3 .github/scripts/utils/prepare_test_matrix.py \
            ${{ env.TESTS_YAML_PATH }} \
            "${{ inputs.enabled-skus }}" \
            ./.github/sku_config.yaml

      - name: Filter matrix by merge_gate
        id: filter-matrix
        run: |
          merge_gate="${{ inputs.merge-gate-call }}"
          matrix='${{ steps.build-matrix.outputs.matrix }}'
          filtered=$(echo "$matrix" | jq -c --argjson mg "$merge_gate" 'map(select((.merge_gate // false) == $mg))')
          len=$(echo "$filtered" | jq 'length')
          if [ "$len" -eq 0 ]; then
            echo "::error::No tests left after filtering for merge_gate=$merge_gate"
            exit 1
          fi
          echo "matrix<<EOF" >> "$GITHUB_OUTPUT"
          echo "$filtered" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

  ttnn:
    needs: load-test-matrix
    strategy:
      fail-fast: false
      matrix:
        test-group: ${{ fromJson(needs.load-test-matrix.outputs.matrix) }}
    name: ${{ matrix.test-group.name }}
    runs-on: ${{ matrix.test-group.runs_on }}
    environment: ${{ github.ref == 'refs/heads/main' && 'mainline' || '' }}
    container:
      image: ${{ matrix.test-group.sku != 'bh_p100' && format('harbor.ci.tenstorrent.net/{0}', inputs.docker-image) || inputs.docker-image || 'docker-image-unresolved!'}}
      env:
        LOGURU_LEVEL: INFO
        PYTHONPATH: /work
      volumes:
        - ${{ github.workspace }}/docker-job:/work # Subdir to workaround https://github.com/actions/runner/issues/691
        - /dev/hugepages-1G:/dev/hugepages-1G
      options: "--device /dev/tenstorrent -e TT_GH_CI_INFRA"
    defaults:
      run:
        shell: bash
        working-directory: /work # https://github.com/actions/runner/issues/878
    steps:
      - name: ðŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}
          submodules: recursive
          path: docker-job
      - name: â¬‡ï¸  Setup Job
        uses: ./docker-job/.github/actions/setup-job
        timeout-minutes: 10
        with:
          wheel-artifact-name: ${{ inputs.wheel-artifact-name }}
          enable-watcher: ${{ inputs.enable-watcher || false }}
          enable-lightweight-kernel-asserts: ${{ inputs.enable-lightweight-kernel-asserts || false }}
          enable-llk-asserts: ${{ inputs.enable-llk-asserts || false }}
          enable-kernel-ccache: true
          # Kernel ccache uses separate Redis backend (REDIS_CCACHE_*) from build ccache (REDIS_*)
          # This allows different retention policies for runtime JIT vs. C++ build artifacts
          redis-ccache-storage: redis://${{ vars.REDIS_CCACHE_USER }}:${{ secrets.REDIS_CCACHE_PASSWORD }}@${{ vars.REDIS_CCACHE_HOST }}:${{ vars.REDIS_CCACHE_PORT }}|read-only=${{ vars.REDIS_CCACHE_IS_READONLY }}
          auto-triage: ${{ !inputs.enable-watcher }}

      - name: Set ttnn fast runtime if exists in config
        if: ${{ matrix.test-group.fast_runtime_mode_off }}
        run: |
          echo "TTNN_CONFIG_OVERRIDES={\"enable_fast_runtime_mode\": false}" >> $GITHUB_ENV

      - name: ${{ matrix.test-group.name }} tests
        timeout-minutes: ${{ inputs.timeout-minutes-override > 0 && inputs.timeout-minutes-override || matrix.test-group.timeout }}
        run: |
          ${{ matrix.test-group.cmd }}

      - name: ðŸ“Š CCache Report
        if: ${{ !cancelled() }}
        run: |
          echo "::group::CCache Statistics"
          ccache --show-stats || echo "ccache stats not available"
          echo "::endgroup::"

      - uses: tenstorrent/tt-metal/.github/actions/slack-report@main
        if: ${{ failure() }}
        with:
          slack_webhook_url: ${{ secrets.SLACK_METAL_INFRA_PIPELINE_STATUS_ALERT }}
          owner: ${{ matrix.test-group.owner_id }}

      - uses: tenstorrent/tt-metal/.github/actions/upload-artifact-with-job-uuid@main
        timeout-minutes: 10
        if: ${{ !cancelled() }}
        with:
          prefix: "test_reports_"

      - uses: tenstorrent/tt-metal/.github/actions/cleanup@main
        if: always()
